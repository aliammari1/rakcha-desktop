<?xml version="1.0" encoding="UTF-8"?>

<?import org.kordamp.ikonli.javafx.FontIcon?>
<?import javafx.geometry.*?>
<?import javafx.scene.Cursor?>
<?import javafx.scene.control.Button?>
<?import javafx.scene.control.ComboBox?>
<?import javafx.scene.control.Label?>
<?import javafx.scene.control.ScrollPane?>
<?import javafx.scene.control.TextArea?>
<?import javafx.scene.control.TextField?>
<?import javafx.scene.image.Image?>
<?import javafx.scene.image.ImageView?>
<?import javafx.scene.layout.AnchorPane?>
<?import javafx.scene.layout.HBox?>
<?import javafx.scene.layout.StackPane?>
<?import javafx.scene.layout.VBox?>
<?import javafx.scene.shape.*?>
<?import javafx.scene.text.Font?>
<?import org.controlsfx.control.Rating?>

<StackPane xmlns="http://javafx.com/javafx/21" xmlns:fx="http://javafx.com/fxml/1"
    fx:controller="com.esprit.controllers.films.FilmUserController"
    styleClass="film-root-pane"
    stylesheets="@../styles/filmStyle.css, @../styles/film-animations.css, @../styles/login-animations.css">

    <!-- Animated Background Layer -->
    <AnchorPane styleClass="animated-shape" AnchorPane.topAnchor="0" AnchorPane.bottomAnchor="0" AnchorPane.leftAnchor="0" AnchorPane.rightAnchor="0">
        
        <!-- Geometric Shapes - Login Theme Style -->
        <Polygon fx:id="filmShape1" points="150.0,300.0,170.0,280.0,190.0,300.0,170.0,320.0" 
            styleClass="rotating-shape, pulsing-shape, rotating-shape-polygon"
            opacity="0.8" />
            
        <Rectangle fx:id="filmShape2" width="35" height="35" layoutX="1350" layoutY="200"
            styleClass="rotating-shape, pulsing-shape, rotating-shape-rectangle"
            opacity="0.8" />
            
        <Circle fx:id="filmShape3" radius="25" layoutX="300" layoutY="700"
            styleClass="pulsing-shape, glow-red, pulsing-circle"
            opacity="0.7" />
            
        <Polygon fx:id="filmShape4" points="1200.0,500.0,1230.0,480.0,1260.0,500.0,1245.0,530.0,1215.0,530.0" 
            styleClass="rotating-shape, rotating-shape-pentagon"
            opacity="0.8" />

        <!-- Floating Particles -->
        <Circle fx:id="filmParticle1" radius="4" layoutX="400" layoutY="300" styleClass="film-particle, film-particle-style" />
        <Circle fx:id="filmParticle2" radius="5" layoutX="900" layoutY="500" styleClass="film-particle, film-particle-style" />
        <Circle fx:id="filmParticle3" radius="3" layoutX="1200" layoutY="400" styleClass="film-particle, film-particle-style" />
        <Circle fx:id="filmParticle4" radius="6" layoutX="600" layoutY="600" styleClass="film-particle, film-particle-style" />
    </AnchorPane>

    <!-- Main Content -->
    <AnchorPane fx:id="anchorPaneFilm" AnchorPane.topAnchor="0" AnchorPane.bottomAnchor="0" AnchorPane.leftAnchor="0" AnchorPane.rightAnchor="0"
        stylesheets="@../styles/filmStyle.css">
        
        <!-- Sidebar -->
        <fx:include source="/ui/sidebar.fxml" />
        
        <!-- Series Navigation Button -->
        <Button fx:id="SerieButton" layoutY="271.0" mnemonicParsing="false"
            onAction="#switchtoSerie" prefHeight="63.0" prefWidth="248.0" styleClass="nav-btn"
            stylesheets="@../styles/filmStyle.css" text="Series              "
            textAlignment="CENTER" />
        <FontIcon fill="#ebe5e5" iconLiteral="fa-tv" layoutX="14.0" layoutY="313.0" />
        
        <!-- Main Content Area -->
        <AnchorPane layoutX="248.0" AnchorPane.topAnchor="0" AnchorPane.bottomAnchor="0" AnchorPane.leftAnchor="248" AnchorPane.rightAnchor="0" styleClass="tab-pane"
            stylesheets="@../styles/filmStyle.css">
            <children>
                <!-- Modern Header with Dark Theme -->
                <HBox alignment="CENTER_LEFT" AnchorPane.topAnchor="0" AnchorPane.leftAnchor="0" AnchorPane.rightAnchor="0" prefHeight="100.0"
                    spacing="20.0" styleClass="dark-gradient-header"
                    style="-fx-background-color: linear-gradient(to bottom, rgba(20, 5, 5, 0.95), rgba(40, 10, 10, 0.9), rgba(20, 5, 5, 0.95)); 
                           -fx-background-radius: 0 0 15 15; 
                           -fx-effect: dropshadow(gaussian, rgba(139, 0, 0, 0.8), 25, 0, 0, 5);
                           -fx-border-color: #8b0000;
                           -fx-border-width: 0 0 2 0;">
                    <padding>
                        <Insets left="20.0" right="20.0" top="10.0" bottom="10.0" />
                    </padding>
                    
                    <!-- Logo and User Info -->
                    <HBox alignment="CENTER_LEFT" spacing="15.0">
                        <ImageView fitHeight="60.0" fitWidth="60.0" pickOnBounds="true" preserveRatio="true">
                            <image>
                                <Image url="@Logo.png" />
                            </image>
                        </ImageView>
                        <VBox spacing="2.0">
                            <Label text="Loujain Hajlaoui" styleClass="animated-text" 
                                style="-fx-text-fill: #ffffff; -fx-font-size: 16px; -fx-font-weight: bold;
                                       -fx-effect: dropshadow(gaussian, #8b0000, 6, 0, 1, 1);" />
                            <Label text="User" style="-fx-text-fill: rgba(255,255,255,0.7); -fx-font-size: 12px;" />
                        </VBox>
                    </HBox>
                    
                    <!-- Spacer -->
                    <HBox HBox.hgrow="ALWAYS" />
                    
                    <!-- Filter Controls -->
                    <HBox alignment="CENTER" spacing="10.0">
                        <ComboBox fx:id="tricomboBox" prefHeight="40.0" prefWidth="150.0" 
                            styleClass="filter-button" promptText="Sort by..." />
                        <Button onAction="#filtrer" prefHeight="40.0" prefWidth="100.0" 
                            styleClass="action-button" text="Filter">
                            <graphic>
                                <FontIcon iconLiteral="fa-filter" fill="white" />
                            </graphic>
                        </Button>
                    </HBox>
                    
                    <!-- Search Bar -->
                    <HBox alignment="CENTER" spacing="5.0" styleClass="search-container">
                        <TextField fx:id="serach_film_user" prefHeight="40.0" prefWidth="250.0" 
                            styleClass="search-bar" promptText="Search movies...">
                            <cursor>
                                <Cursor fx:constant="TEXT" />
                            </cursor>
                        </TextField>
                        <Button mnemonicParsing="false" styleClass="action-button" 
                            prefHeight="40.0" prefWidth="40.0">
                            <graphic>
                                <FontIcon fill="white" iconLiteral="fa-search" />
                            </graphic>
                        </Button>
                    </HBox>
                </HBox>
                
                <!-- Content Area with Cards -->
                <HBox AnchorPane.topAnchor="120.0" AnchorPane.leftAnchor="0" AnchorPane.rightAnchor="0" AnchorPane.bottomAnchor="0" spacing="15.0">
                    <padding>
                        <Insets left="15.0" right="15.0" top="15.0" bottom="15.0" />
                    </padding>
                    
                    <!-- Left Column - All Movies -->
                    <VBox spacing="15.0" HBox.hgrow="ALWAYS" prefWidth="750.0">
                        <Label text="All Movies" styleClass="section-title, animated-text"
                            style="-fx-font-size: 28px; -fx-font-weight: bold; -fx-text-fill: #ffffff;
                                   -fx-effect: dropshadow(gaussian, #ff4444, 12, 0, 2, 2);" />
                        <ScrollPane fx:id="filmScrollPane" fitToHeight="true" fitToWidth="true"
                            hbarPolicy="NEVER" vbarPolicy="AS_NEEDED" styleClass="film-scroll"
                            style="-fx-background-color: transparent; -fx-background: transparent;"
                            VBox.vgrow="ALWAYS">
                            <VBox spacing="0.0" style="-fx-background-color: transparent;" />
                        </ScrollPane>
                    </VBox>
                    
                    <!-- Right Column - Top 3 Movies -->
                    <VBox spacing="15.0" prefWidth="420.0">
                        <HBox alignment="CENTER_LEFT" spacing="15.0">
                            <Label text="Top Movies" styleClass="section-title, animated-text"
                                style="-fx-font-size: 28px; -fx-font-weight: bold; -fx-text-fill: #ffffff;
                                       -fx-effect: dropshadow(gaussian, #ff4444, 12, 0, 2, 2);" />
                            <ComboBox fx:id="top3combobox" prefHeight="45.0" prefWidth="150.0" 
                                styleClass="filter-button" promptText="Category" />
                        </HBox>
                        
                        <!-- Top 3 Container -->
                        <ScrollPane fitToWidth="true" hbarPolicy="NEVER" vbarPolicy="AS_NEEDED" 
                            styleClass="film-scroll" style="-fx-background-color: transparent; -fx-background: transparent;"
                            VBox.vgrow="ALWAYS">
                            <VBox fx:id="topthreeVbox" spacing="20.0" styleClass="top-films-container"
                                style="-fx-background-color: transparent;">
                                <padding>
                                    <Insets top="10.0" />
                                </padding>
                            </VBox>
                        </ScrollPane>
                        
                        <!-- Alternative Top 3 (hidden by default) -->
                        <VBox fx:id="topthreeVbox1" spacing="20.0" visible="false"
                            style="-fx-background-color: transparent;" />
                    </VBox>
                </HBox>
            </children>
        </AnchorPane>
    </AnchorPane>
    
    <!-- Film Detail Modal -->
    <AnchorPane fx:id="detalAnchorPane" layoutX="280.0" layoutY="68.0" prefHeight="719.0"
        prefWidth="942.0" styleClass="detail-modal" stylesheets="@../styles/filmStyle.css"
        visible="false"
        style="-fx-background-color: white; -fx-background-radius: 15; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.4), 20, 0, 0, 5);">
        <children>
            <!-- Close Button -->
            <Button fx:id="closeDetailFilm" layoutX="880.0" layoutY="14.0" mnemonicParsing="false"
                prefHeight="35.0" prefWidth="48.0" styleClass="close"
                stylesheets="@../styles/filmStyle.css">
                <graphic>
                    <FontIcon iconLiteral="fa-close" styleClass="close" />
                </graphic>
            </Button>
            
            <!-- Film Image -->
            <ImageView fx:id="imagefilmDetail" fitHeight="421.0" fitWidth="348.0" layoutX="57.0"
                layoutY="57.0" pickOnBounds="true" preserveRatio="true" 
                style="-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 15, 0, 0, 5);" />
            
            <!-- Film Title -->
            <Label fx:id="filmNomDetail" layoutX="422.0" layoutY="56.0" prefHeight="62.0"
                prefWidth="400.0" text="Film Name" wrapText="true"
                style="-fx-font-size: 26px; -fx-font-weight: bold; -fx-text-fill: #2c3e50;">
                <font>
                    <Font size="26.0" />
                </font>
            </Label>
            
            <!-- Average Rating -->
            <HBox alignment="CENTER_LEFT" layoutX="735.0" layoutY="70.0" spacing="8.0">
                <FontIcon fill="#f2b604" iconLiteral="fa-star" iconSize="24" />
                <Label fx:id="labelavregeRate" text="4.5/5" style="-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: #2c3e50;">
                    <font>
                        <Font size="20.0" />
                    </font>
                </Label>
            </HBox>
            
            <!-- Description -->
            <TextArea fx:id="descriptionDETAILfilm" editable="false" layoutX="422.0" layoutY="110.0"
                prefHeight="384.0" prefWidth="402.0" wrapText="true" 
                styleClass="description-area"
                style="-fx-background-color: #f8f9fa; -fx-background-radius: 10; -fx-padding: 15;" />
            
            <!-- User Rating -->
            <VBox alignment="CENTER" layoutX="57.0" layoutY="494.0" spacing="10.0">
                <Label text="Rate this film:" style="-fx-font-size: 14px; -fx-text-fill: #7f8c8d;" />
                <Rating fx:id="filmRate" prefHeight="35.0" prefWidth="240.0" rating="0.0" />
            </VBox>
            
            <!-- Comment Icon -->
            <Button layoutX="275.0" layoutY="500.0" mnemonicParsing="false" 
                onMouseClicked="#afficherAnchorComment" styleClass="action-button"
                prefHeight="40.0" prefWidth="110.0" text="Comments">
                <graphic>
                    <FontIcon fill="white" iconLiteral="fa-commenting" />
                </graphic>
            </Button>
            
            <!-- Action Buttons -->
            <HBox alignment="CENTER" layoutX="422.0" layoutY="505.0" spacing="15.0">
                <Button fx:id="trailer_Button" mnemonicParsing="false"
                    prefHeight="42.0" prefWidth="172.0" styleClass="action-button"
                    stylesheets="@../styles/filmStyle.css" text="Watch Trailer">
                    <graphic>
                        <FontIcon iconLiteral="fa-play" fill="white" />
                    </graphic>
                    <cursor>
                        <Cursor fx:constant="HAND" />
                    </cursor>
                </Button>
                <Button fx:id="reserver_Film" mnemonicParsing="false"
                    prefHeight="42.0" prefWidth="172.0" styleClass="action-button"
                    stylesheets="@../styles/filmStyle.css" text="RESERVE">
                    <graphic>
                        <FontIcon iconLiteral="fa-ticket" fill="white" />
                    </graphic>
                    <cursor>
                        <Cursor fx:constant="HAND" />
                    </cursor>
                </Button>
            </HBox>
            
            <!-- QR Code -->
            <VBox alignment="CENTER" layoutX="680.0" layoutY="556.0" spacing="8.0">
                <Label text="Scan to Reserve" style="-fx-font-size: 12px; -fx-text-fill: #7f8c8d;" />
                <ImageView fx:id="qrcode" fitHeight="140.0" fitWidth="140.0" pickOnBounds="true" preserveRatio="true" 
                    style="-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.2), 10, 0, 0, 3);" />
            </VBox>
            
            <!-- Comments Panel (nested) -->
            <AnchorPane fx:id="commentAnchorPane" layoutX="170.0" layoutY="48.0" prefHeight="638.0"
                prefWidth="499.0" styleClass="bg-white" stylesheets="@../styles/filmStyle.css"
                visible="false"
                style="-fx-background-color: white; -fx-background-radius: 15; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 15, 0, 0, 5);">
                <children>
                    <Button fx:id="closeDetailFilm1" layoutX="443.0" layoutY="6.0"
                        mnemonicParsing="false" prefHeight="35.0" prefWidth="48.0"
                        styleClass="close" stylesheets="@../styles/filmStyle.css">
                        <graphic>
                            <FontIcon iconLiteral="fa-close" styleClass="close" />
                        </graphic>
                    </Button>
                    <Label text="Comments" layoutX="20.0" layoutY="10.0" 
                        style="-fx-font-size: 18px; -fx-font-weight: bold; -fx-text-fill: #2c3e50;" />
                    <ScrollPane fitToHeight="true" fitToWidth="true" layoutX="13.0" layoutY="41.0"
                        prefHeight="519.0" prefWidth="465.0" styleClass="film-scroll"
                        style="-fx-background-color: transparent;">
                        <content>
                            <VBox fx:id="commentVBox" prefWidth="450.0" spacing="10.0" 
                                style="-fx-background-color: transparent; -fx-padding: 10;" />
                        </content>
                    </ScrollPane>
                    <HBox alignment="CENTER_LEFT" layoutX="20.0" layoutY="575.0" spacing="10.0">
                        <TextField fx:id="commentTextField" prefHeight="40.0" HBox.hgrow="ALWAYS"
                            styleClass="search-bar" promptText="Write a comment..." />
                        <Button mnemonicParsing="false" styleClass="action-button" prefHeight="40.0" prefWidth="40.0">
                            <graphic>
                                <FontIcon fx:id="sendIcon" fill="white" iconLiteral="fa-send" />
                            </graphic>
                        </Button>
                    </HBox>
                </children>
            </AnchorPane>
            
            <!-- Alternative Comments Panel -->
            <AnchorPane fx:id="AnchorComments" layoutX="423.0" layoutY="120.0" prefHeight="535.0"
                prefWidth="426.0" styleClass="bg-white" visible="false"
                style="-fx-background-color: white; -fx-background-radius: 15; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 15, 0, 0, 5);">
                <children>
                    <Button fx:id="closeDetailFilm2" layoutX="374.0" layoutY="2.0"
                        mnemonicParsing="false" onAction="#closercommets" prefHeight="35.0"
                        prefWidth="48.0" styleClass="close" stylesheets="@../styles/filmStyle.css">
                        <graphic>
                            <FontIcon iconLiteral="fa-close" styleClass="close" />
                        </graphic>
                    </Button>
                    <Label text="Comments" layoutX="20.0" layoutY="10.0" 
                        style="-fx-font-size: 18px; -fx-font-weight: bold; -fx-text-fill: #2c3e50;" />
                    <ScrollPane fx:id="ScrollPaneComments" layoutY="37.0" prefHeight="442.0"
                        prefWidth="426.0" styleClass="film-scroll"
                        style="-fx-background-color: transparent;">
                        <content>
                            <VBox spacing="10.0" style="-fx-background-color: transparent; -fx-padding: 15;" />
                        </content>
                    </ScrollPane>
                    <HBox alignment="CENTER_LEFT" layoutX="15.0" layoutY="486.0" spacing="10.0" prefWidth="396.0">
                        <TextField fx:id="txtAreaComments" prefHeight="42.0" HBox.hgrow="ALWAYS"
                            styleClass="search-bar" promptText="Write a comment...">
                            <cursor>
                                <Cursor fx:constant="TEXT" />
                            </cursor>
                        </TextField>
                        <Button mnemonicParsing="false" onMouseClicked="#AddComment" 
                            styleClass="action-button" prefHeight="42.0" prefWidth="42.0">
                            <graphic>
                                <FontIcon fill="white" iconLiteral="fa-send" />
                            </graphic>
                        </Button>
                    </HBox>
                </children>
            </AnchorPane>
        </children>
    </AnchorPane>
    
    <!-- Trailer Overlay -->
    <AnchorPane fx:id="anchorPane_Trailer" layoutX="400.0" layoutY="200.0" prefHeight="453.0"
        prefWidth="702.0" visible="false" 
        style="-fx-background-color: black; -fx-background-radius: 15; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.5), 25, 0, 0, 5);" />
    
    <!-- Filter Panel -->
    <AnchorPane fx:id="Anchore_Pane_filtrage" layoutX="630.0" layoutY="200.0" prefHeight="442.0"
        prefWidth="250.0" styleClass="bg-white" visible="false"
        style="-fx-background-color: white; -fx-background-radius: 15; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 20, 0, 0, 5);">
        <children>
            <Label text="Filter Options" layoutX="20.0" layoutY="20.0" 
                style="-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: #2c3e50;" />
            <Button fx:id="bouttonAnchor_outfilltrer" layoutX="75.0" layoutY="380.0"
                mnemonicParsing="false" onAction="#filtrercinema" prefHeight="42.0" prefWidth="100.0"
                styleClass="action-button" text="Apply">
                <graphic>
                    <FontIcon iconLiteral="fa-check" fill="white" />
                </graphic>
            </Button>
        </children>
    </AnchorPane>
</StackPane>
