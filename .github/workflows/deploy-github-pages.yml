name: Deploy to GitHub Pages with Conveyor

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy:
        description: "Deploy to GitHub Pages"
        required: false
        default: "true"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: false

env:
  JAVA_VERSION: "21"
  CONVEYOR_VERSION: "20.0"

jobs:
  build-conveyor-site:
    name: Build Conveyor Download Site
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"
          cache: maven

      - name: Install Maven
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y maven
          mvn --version

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build application with Maven
        run: |
          mvn clean package -DskipTests -B -V

          # Verify build artifacts
          echo "ðŸ“¦ Build artifacts:"
          ls -lh target/*.jar

          # Create classpath-jars directory if it doesn't exist
          mkdir -p target/classpath-jars

          # Copy dependencies to classpath-jars
          mvn dependency:copy-dependencies -DoutputDirectory=target/classpath-jars

      - name: Cache Conveyor installation
        uses: actions/cache@v4
        id: cache-conveyor
        with:
          path: |
            ~/.cache/hydraulic/conveyor
            ~/.local/bin/conveyor
          key: ${{ runner.os }}-conveyor-${{ env.CONVEYOR_VERSION }}
          restore-keys: |
            ${{ runner.os }}-conveyor-

      - name: Download and setup Conveyor
        if: steps.cache-conveyor.outputs.cache-hit != 'true'
        run: |
          echo "â¬‡ï¸ Downloading Conveyor..."

          # Create local bin directory
          mkdir -p "$HOME/.local/bin"

          # Try the official install script first
          echo "ðŸ”„ Trying official install script..."
          if curl -L https://downloads.hydraulic.dev/conveyor/install.sh | bash; then
            echo "âœ… Official install script succeeded"
          else
            echo "âš ï¸ Official script failed, trying manual installation..."
            
            # Manual installation as fallback
            CONVEYOR_URL="https://downloads.hydraulic.dev/conveyor/conveyor-${CONVEYOR_VERSION}-linux-amd64.tar.gz"
            echo "ðŸ“¥ Downloading from: $CONVEYOR_URL"
            
            curl -L "$CONVEYOR_URL" -o conveyor.tar.gz
            tar -xzf conveyor.tar.gz
            
            # Find the conveyor binary
            CONVEYOR_BIN=$(find . -name "conveyor" -type f -executable | head -1)
            if [ -n "$CONVEYOR_BIN" ]; then
              cp "$CONVEYOR_BIN" "$HOME/.local/bin/conveyor"
              chmod +x "$HOME/.local/bin/conveyor"
              echo "âœ… Manual installation completed"
            else
              echo "âŒ Could not find conveyor binary"
              exit 1
            fi
            
            # Cleanup
            rm -rf conveyor.tar.gz conveyor-*
          fi

          # Verify installation
          export PATH="$HOME/.local/bin:$PATH"
          echo "âœ… Conveyor installed:"
          "$HOME/.local/bin/conveyor" --version

      - name: Add Conveyor to PATH
        run: |
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Generate or use signing key
        id: signing-key
        run: |
          if [ -z "${{ secrets.CONVEYOR_SIGNING_KEY }}" ]; then
            echo "ðŸ”‘ Generating temporary signing key for development..."
            TEMP_KEY=$(conveyor keys generate)
            echo "signing_key=$TEMP_KEY" >> $GITHUB_OUTPUT
            echo "âš ï¸ Using temporary signing key. Set CONVEYOR_SIGNING_KEY secret for production."
          else
            echo "ðŸ” Using provided signing key from secrets"
            echo "signing_key=${{ secrets.CONVEYOR_SIGNING_KEY }}" >> $GITHUB_OUTPUT
          fi

      - name: Determine site base URL
        id: site-url
        run: |
          if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/main" ]; then
            SITE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          else
            # For PRs and feature branches, use localhost for testing
            SITE_URL="localhost"
          fi
          echo "site_url=$SITE_URL" >> $GITHUB_OUTPUT
          echo "ðŸ“ Site URL: $SITE_URL"

      - name: Create CI Conveyor config
        run: |
          cat > ci.conveyor.conf << 'EOF'
          // CI-specific configuration for GitHub Actions
          include required("conveyor.conf")

          // Override site URL for GitHub Pages
          app {
            site {
              base-url = "${{ steps.site-url.outputs.site_url }}"
            }
            
            // Use version from Maven
            version = "1.0.6"
            
            // VCS information for GitHub
            vcs-url = "https://github.com/${{ github.repository }}"
            
            // Update settings
            updates = aggressive
          }

          // Signing key from environment
          app.signing-key = ${?SIGNING_KEY}

          // Compatibility level
          conveyor.compatibility-level = 18
          EOF

          echo "ðŸ“„ CI Conveyor config created:"
          cat ci.conveyor.conf

      - name: Build Conveyor packages and site
        run: |
          echo "ðŸ—ï¸ Building Conveyor packages..."

          # Ensure cache directory exists
          mkdir -p $HOME/.cache/hydraulic/conveyor

          # Build packages using CI config with proper parallelism
          conveyor -f ci.conveyor.conf make site

          echo "âœ… Conveyor build complete!"
        env:
          SIGNING_KEY: ${{ steps.signing-key.outputs.signing_key }}
          CONVEYOR_CACHE_DIR: $HOME/.cache/hydraulic/conveyor

      - name: List generated artifacts
        run: |
          echo "ðŸ“¦ Generated packages and site:"
          find output -type f | sort

          echo ""
          echo "ðŸ“Š File sizes:"
          find output -type f -exec ls -lh {} \; | awk '{print $5, $9}'

      - name: Upload Conveyor artifacts
        uses: actions/upload-artifact@v4
        with:
          name: conveyor-packages-${{ github.sha }}
          path: output/
          retention-days: 30

      - name: Setup Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: "output/download-site"

      - name: Create build summary
        if: always()
        run: |
          echo "## ðŸŽ‰ Conveyor Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Conveyor Version:** ${{ env.CONVEYOR_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Site URL:** ${{ steps.site-url.outputs.site_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "### ðŸŒ Deployment" >> $GITHUB_STEP_SUMMARY
            echo "Site will be deployed to: **https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### ðŸ“¦ Packages Generated" >> $GITHUB_STEP_SUMMARY
          echo "- Windows (.msi, .exe)" >> $GITHUB_STEP_SUMMARY
          echo "- macOS (.dmg)" >> $GITHUB_STEP_SUMMARY
          echo "- Linux (.deb, .rpm, .tar.gz)" >> $GITHUB_STEP_SUMMARY

  deploy-pages:
    name: Deploy to GitHub Pages
    needs: build-conveyor-site
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Create deployment summary
        run: |
          echo "## âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Live Site" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Available Downloads" >> $GITHUB_STEP_SUMMARY
          echo "Visitors can download RAKCHA Desktop for:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Windows (MSI installer with auto-updates)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… macOS (DMG with code signing)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Linux (DEB, RPM packages)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Updates" >> $GITHUB_STEP_SUMMARY
          echo "All packages support automatic updates via Conveyor" >> $GITHUB_STEP_SUMMARY

  create-release:
    name: Create GitHub Release
    needs: build-conveyor-site
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: conveyor-packages-${{ github.sha }}
          path: output/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: RAKCHA Desktop ${{ github.ref_name }}
          body: |
            ## RAKCHA Desktop Release ${{ github.ref_name }}

            ### ðŸ“¥ Download

            Choose your platform:
            - **Windows:** Download the `.msi` installer
            - **macOS:** Download the `.dmg` file
            - **Linux:** Download `.deb` (Ubuntu/Debian) or `.rpm` (Fedora/RHEL)

            ### âœ¨ Features
            - ðŸŽ¬ Cinema & Film Management
            - ðŸ“º Series & Episode Tracking
            - ðŸ›ï¸ Product Marketplace
            - ðŸ’³ Integrated Payments (Stripe/PayPal)
            - ðŸ” Multi-factor Authentication
            - ðŸ”„ Automatic Updates

            ### ðŸ”§ Installation

            **Windows:**
            ```
            Download RAKCHA-1.0.6.msi
            Double-click to install
            ```

            **macOS:**
            ```
            Download RAKCHA-1.0.6.dmg
            Drag to Applications folder
            ```

            **Linux (Debian/Ubuntu):**
            ```bash
            sudo dpkg -i rakcha_1.0.6_amd64.deb
            ```

            **Linux (Fedora/RHEL):**
            ```bash
            sudo rpm -i rakcha-1.0.6.x86_64.rpm
            ```

            ### ðŸ“ Changelog
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

            ### ðŸ› Report Issues
            Found a bug? [Open an issue](https://github.com/${{ github.repository }}/issues/new)

            ---

            **Built from commit:** `${{ github.sha }}`  
            **Build date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          files: |
            output/**/*.msi
            output/**/*.dmg
            output/**/*.deb
            output/**/*.rpm
            output/**/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Send Notifications
    needs: [build-conveyor-site, deploy-pages]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Check deployment status
        run: |
          if [ "${{ needs.deploy-pages.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Deployment successful"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "âŒ Deployment failed"
          fi
        id: status

      - name: Create notification summary
        run: |
          echo "## ðŸ“¢ Deployment Notification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.status.outputs.status }}" == "success" ]; then
            echo "âœ… **Status:** Deployment completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ **Live Site:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Deployment failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi

    # Optional: Add Slack, Discord, or email notifications here
    # - name: Send Slack notification
    #   uses: 8398a7/action-slack@v3
    #   with:
    #     status: ${{ steps.status.outputs.status }}
    #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
