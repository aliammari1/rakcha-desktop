name: Test Conveyor Setup

on:
  workflow_dispatch:

env:
  JAVA_VERSION: "21"
  CONVEYOR_VERSION: "21.0"

jobs:
  test-conveyor:
    name: Test Conveyor Installation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"

      - name: Cache Conveyor installation
        uses: actions/cache@v4
        id: cache-conveyor
        with:
          path: |
            ~/.cache/hydraulic/conveyor
            ~/.local/bin/conveyor
          key: ${{ runner.os }}-conveyor-${{ env.CONVEYOR_VERSION }}
          restore-keys: |
            ${{ runner.os }}-conveyor-

      - name: Download and setup Conveyor
        if: steps.cache-conveyor.outputs.cache-hit != 'true'
        run: |
          echo "‚¨áÔ∏è Downloading Conveyor..."

          # Create local bin directory
          mkdir -p "$HOME/.local/bin"

          # Manual installation (official script is unreliable)
          CONVEYOR_URL="https://downloads.hydraulic.dev/conveyor/conveyor-${CONVEYOR_VERSION}-linux-amd64.tar.gz"
          echo "üì• Downloading from: $CONVEYOR_URL"

          curl -L "$CONVEYOR_URL" -o conveyor.tar.gz
          tar -xzf conveyor.tar.gz

          # Find the conveyor binary
          CONVEYOR_BIN=$(find . -name "conveyor" -type f -executable | head -1)
          if [ -n "$CONVEYOR_BIN" ]; then
            cp "$CONVEYOR_BIN" "$HOME/.local/bin/conveyor"
            chmod +x "$HOME/.local/bin/conveyor"
            echo "‚úÖ Manual installation completed"
          else
            echo "‚ùå Could not find conveyor binary"
            exit 1
          fi

          # Cleanup
          rm -rf conveyor.tar.gz conveyor-*

          # Verify installation
          export PATH="$HOME/.local/bin:$PATH"

          # Set up Java library path for Conveyor
          export LD_LIBRARY_PATH="$JAVA_HOME/lib/server:$JAVA_HOME/lib:$LD_LIBRARY_PATH"

          echo "‚úÖ Conveyor installed:"
          echo "Java Home: $JAVA_HOME"
          echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH"
          "$HOME/.local/bin/conveyor" --version

      - name: Add Conveyor to PATH
        run: |
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Test Conveyor commands
        run: |
          # Set up Java library path for Conveyor
          export LD_LIBRARY_PATH="$JAVA_HOME/lib/server:$JAVA_HOME/lib:$LD_LIBRARY_PATH"

          echo "üß™ Testing basic Conveyor commands..."
          conveyor --help | head -10

          echo ""
          echo "üîç Testing Conveyor info command..."
          conveyor info || echo "‚ÑπÔ∏è Info command failed (expected for projects without conveyor.conf)"
