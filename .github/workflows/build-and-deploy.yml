name: Build and Deploy RAKCHA Desktop

on:
  push:
    branches: [main, master]
    tags: ["v*"]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  JAVA_VERSION: "21"
  JAVA_DISTRIBUTION: "liberica"
  APP_VERSION: "1.0.8"
  APP_NAME: "RAKCHA"
  MAIN_CLASS: "com.esprit.MainApp"

jobs:
  build-linux:
    runs-on: ubuntu-latest
    name: Build Linux Distribution
    continue-on-error: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-package: jdk+fx
          cache: maven

      - name: Install Linux dependencies for jpackage
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot dpkg-dev binutils

      - name: Build application with Maven
        run: |
          mvn clean compile package -DskipTests -B -V
          cp target/${{ env.APP_NAME }}-${{ env.APP_VERSION }}.jar target/classpath-jars/

      - name: Build Debian package with jpackage
        run: |
          jpackage --type deb \
            --input target/classpath-jars \
            --main-jar ${{ env.APP_NAME }}-${{ env.APP_VERSION }}.jar \
            --main-class ${{ env.MAIN_CLASS }} \
            --name ${{ env.APP_NAME }} \
            --app-version ${{ env.APP_VERSION }} \
            --dest target/dist \
            --java-options "-Xms256m" \
            --java-options "-Xmx1024m" \
            --java-options "-Dfile.encoding=UTF-8" \
            --vendor "ESPRIT" \
            --description "RAKCHA Desktop - Movie and Cinema Management System" \
            --verbose

      - name: Build Linux portable app-image
        run: |
          jpackage --type app-image \
            --input target/classpath-jars \
            --main-jar ${{ env.APP_NAME }}-${{ env.APP_VERSION }}.jar \
            --main-class ${{ env.MAIN_CLASS }} \
            --name ${{ env.APP_NAME }} \
            --app-version ${{ env.APP_VERSION }} \
            --dest target/app-image \
            --java-options "-Xms256m" \
            --java-options "-Xmx1024m" \
            --java-options "-Dfile.encoding=UTF-8" \
            --vendor "ESPRIT" \
            --description "RAKCHA Desktop - Movie and Cinema Management System" \
            --verbose

      - name: Create portable archive
        run: |
          cd target/app-image
          tar -czf ../../${{ env.APP_NAME }}-${{ env.APP_VERSION }}-linux-portable.tar.gz ${{ env.APP_NAME }}/

      - name: Verify Linux artifacts
        run: |
          echo "=== Debian Package ===" 
          ls -lh target/dist/*.deb || echo "No .deb package found"
          echo "=== Portable Archive ===" 
          ls -lh ${{ env.APP_NAME }}-${{ env.APP_VERSION }}-linux-portable.tar.gz

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-distributions
          path: |
            target/dist/*.deb
            ${{ env.APP_NAME }}-${{ env.APP_VERSION }}-linux-portable.tar.gz
          retention-days: 90
          if-no-files-found: warn

  build-windows:
    runs-on: windows-latest
    name: Build Windows Distribution
    continue-on-error: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-package: jdk+fx
          cache: maven

      - name: Build application with Maven
        run: |
          mvn clean compile package -DskipTests -B -V
          copy target\${{ env.APP_NAME }}-${{ env.APP_VERSION }}.jar target\classpath-jars\

      - name: Build Windows MSI installer with jpackage
        run: |
          jpackage --type msi `
            --input target\classpath-jars `
            --main-jar ${{ env.APP_NAME }}-${{ env.APP_VERSION }}.jar `
            --main-class ${{ env.MAIN_CLASS }} `
            --name ${{ env.APP_NAME }} `
            --app-version ${{ env.APP_VERSION }} `
            --dest target\dist `
            --vendor "ESPRIT" `
            --description "RAKCHA Desktop - Movie and Cinema Management System" `
            --copyright "Copyright Â© 2025 ESPRIT" `
            --win-menu `
            --win-shortcut `
            --win-menu-group "RAKCHA" `
            --java-options "-Xms256m" `
            --java-options "-Xmx1024m" `
            --java-options "-Dfile.encoding=UTF-8" `
            --verbose
        shell: powershell

      - name: Build Windows portable app-image
        run: |
          jpackage --type app-image `
            --input target\classpath-jars `
            --main-jar ${{ env.APP_NAME }}-${{ env.APP_VERSION }}.jar `
            --main-class ${{ env.MAIN_CLASS }} `
            --name ${{ env.APP_NAME }} `
            --app-version ${{ env.APP_VERSION }} `
            --dest target\app-image `
            --vendor "ESPRIT" `
            --description "RAKCHA Desktop - Movie and Cinema Management System" `
            --java-options "-Xms256m" `
            --java-options "-Xmx1024m" `
            --java-options "-Dfile.encoding=UTF-8" `
            --verbose
        shell: powershell

      - name: Create portable archive
        run: |
          $appImagePath = "target\app-image\${{ env.APP_NAME }}"
          if (Test-Path $appImagePath) {
            Compress-Archive -Path "$appImagePath\*" -DestinationPath "${{ env.APP_NAME }}-${{ env.APP_VERSION }}-windows-portable.zip" -Force
            Write-Host "Created portable archive successfully"
          } else {
            Write-Host "ERROR: App image not found at $appImagePath"
            exit 1
          }
        shell: powershell

      - name: Verify Windows artifacts
        run: |
          Write-Host "=== MSI Installer ===" 
          Get-ChildItem target\dist\*.msi -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "$($_.Name) - $([math]::Round($_.Length/1MB, 2)) MB" }
          Write-Host "=== Portable Archive ===" 
          Get-ChildItem ${{ env.APP_NAME }}-${{ env.APP_VERSION }}-windows-portable.zip -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "$($_.Name) - $([math]::Round($_.Length/1MB, 2)) MB" }
        shell: powershell

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-distributions
          path: |
            target/dist/*.msi
            ${{ env.APP_NAME }}-${{ env.APP_VERSION }}-windows-portable.zip
          retention-days: 90
          if-no-files-found: warn

  build-macos:
    runs-on: macos-latest
    name: Build macOS Distribution
    continue-on-error: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-package: jdk+fx
          cache: maven

      - name: Build application with Maven
        run: |
          mvn clean compile package -DskipTests -B -V
          cp target/${{ env.APP_NAME }}-${{ env.APP_VERSION }}.jar target/classpath-jars/

      - name: Build macOS DMG installer with jpackage
        run: |
          jpackage --type dmg \
            --input target/classpath-jars \
            --main-jar ${{ env.APP_NAME }}-${{ env.APP_VERSION }}.jar \
            --main-class ${{ env.MAIN_CLASS }} \
            --name ${{ env.APP_NAME }} \
            --app-version ${{ env.APP_VERSION }} \
            --dest target/dist \
            --vendor "ESPRIT" \
            --description "RAKCHA Desktop - Movie and Cinema Management System" \
            --copyright "Copyright Â© 2025 ESPRIT" \
            --mac-package-name "${{ env.APP_NAME }}" \
            --java-options "-Xms256m" \
            --java-options "-Xmx1024m" \
            --java-options "-Dfile.encoding=UTF-8" \
            --verbose

      - name: Build macOS portable app-image
        run: |
          jpackage --type app-image \
            --input target/classpath-jars \
            --main-jar ${{ env.APP_NAME }}-${{ env.APP_VERSION }}.jar \
            --main-class ${{ env.MAIN_CLASS }} \
            --name ${{ env.APP_NAME }} \
            --app-version ${{ env.APP_VERSION }} \
            --dest target/app-image \
            --vendor "ESPRIT" \
            --description "RAKCHA Desktop - Movie and Cinema Management System" \
            --java-options "-Xms256m" \
            --java-options "-Xmx1024m" \
            --java-options "-Dfile.encoding=UTF-8" \
            --verbose

      - name: Create portable archive
        run: |
          cd target/app-image
          tar -czf ../../${{ env.APP_NAME }}-${{ env.APP_VERSION }}-macos-portable.tar.gz ${{ env.APP_NAME }}.app/

      - name: Verify macOS artifacts
        run: |
          echo "=== DMG Installer ===" 
          ls -lh target/dist/*.dmg 2>/dev/null || echo "No .dmg installer found"
          echo "=== Portable Archive ===" 
          ls -lh ${{ env.APP_NAME }}-${{ env.APP_VERSION }}-macos-portable.tar.gz

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-distributions
          path: |
            target/dist/*.dmg
            ${{ env.APP_NAME }}-${{ env.APP_VERSION }}-macos-portable.tar.gz
          retention-days: 90
          if-no-files-found: warn

  deploy-website:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    name: Deploy to GitHub Pages
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Linux artifacts
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: linux-distributions
          path: artifacts/linux/

      - name: Download Windows artifacts
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: windows-distributions
          path: artifacts/windows/

      - name: Download macOS artifacts
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: macos-distributions
          path: artifacts/macos/

      - name: Prepare website
        run: |
          cp -r website/* ./
          mkdir -p releases/linux releases/windows releases/macos
          
          # Copy platform-specific files with version naming
          if [ -d "artifacts/linux" ]; then
            find artifacts/linux -type f \( -name "*.deb" -o -name "*.tar.gz" \) -exec cp {} releases/linux/ \;
          fi
          
          if [ -d "artifacts/windows" ]; then
            find artifacts/windows -type f \( -name "*.msi" -o -name "*.zip" \) -exec cp {} releases/windows/ \;
          fi
          
          if [ -d "artifacts/macos" ]; then
            find artifacts/macos -type f \( -name "*.dmg" -o -name "*.tar.gz" \) -exec cp {} releases/macos/ \;
          fi
          
          # Generate release information
          echo "# RAKCHA Desktop Installers" > releases/README.md
          echo "" >> releases/README.md
          echo "Built with jpackage for native platform integration." >> releases/README.md
          echo "" >> releases/README.md
          
          for platform in linux windows macos; do
            echo "## ${platform^} Installers" >> releases/README.md
            for file in releases/$platform/*; do
              if [[ -f "$file" ]]; then
                size=$(du -h "$file" | cut -f1)
                filename=$(basename "$file")
                echo "- **$filename** - Size: $size" >> releases/README.md
              fi
            done
            echo "" >> releases/README.md
          done

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  create-release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    name: Create GitHub Release
    if: always() && startsWith(github.ref, 'refs/tags/')

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Linux artifacts
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: linux-distributions
          path: artifacts/linux/

      - name: Download Windows artifacts
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: windows-distributions
          path: artifacts/windows/

      - name: Download macOS artifacts
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: macos-distributions
          path: artifacts/macos/

      - name: Collect all artifacts
        run: |
          mkdir -p release-artifacts
          find artifacts -type f \( -name "*.deb" -o -name "*.msi" -o -name "*.dmg" -o -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-artifacts/ \;

      - name: Generate release notes
        run: |
          echo "# RAKCHA Desktop ${GITHUB_REF#refs/tags/}" > release-notes.md
          echo "" >> release-notes.md
          echo "Built with **jpackage** for native platform installers with integrated Java runtime." >> release-notes.md
          echo "" >> release-notes.md
          echo "## ðŸ“¦ Downloads" >> release-notes.md
          echo "" >> release-notes.md
          
          # Linux section
          echo "### ðŸ§ Linux" >> release-notes.md
          for file in artifacts/linux/*; do
            if [[ -f "$file" ]]; then
              filename=$(basename "$file")
              size=$(du -h "$file" | cut -f1)
              
              if [[ $filename == *.deb ]]; then
                echo "- **$filename** (${size}) - Debian/Ubuntu installer package (recommended)" >> release-notes.md
              elif [[ $filename == *portable* ]]; then
                echo "- **$filename** (${size}) - Portable application archive (no installation required)" >> release-notes.md
              fi
            fi
          done
          
          # Windows section  
          echo "" >> release-notes.md
          echo "### ðŸªŸ Windows" >> release-notes.md
          for file in artifacts/windows/*; do
            if [[ -f "$file" ]]; then
              filename=$(basename "$file")
              size=$(du -h "$file" | cut -f1)
              
              if [[ $filename == *.msi ]]; then
                echo "- **$filename** (${size}) - Windows MSI installer (recommended)" >> release-notes.md
              elif [[ $filename == *portable* ]]; then
                echo "- **$filename** (${size}) - Portable application archive (no installation required)" >> release-notes.md
              fi
            fi
          done
          
          # macOS section
          echo "" >> release-notes.md
          echo "### ðŸŽ macOS" >> release-notes.md
          for file in artifacts/macos/*; do
            if [[ -f "$file" ]]; then
              filename=$(basename "$file")
              size=$(du -h "$file" | cut -f1)
              
              if [[ $filename == *.dmg ]]; then
                echo "- **$filename** (${size}) - macOS DMG disk image installer (recommended)" >> release-notes.md
              elif [[ $filename == *portable* ]]; then
                echo "- **$filename** (${size}) - Portable application archive (no installation required)" >> release-notes.md
              fi
            fi
          done
          
          echo "" >> release-notes.md
          echo "## ðŸ“‹ Installation Instructions" >> release-notes.md
          echo "" >> release-notes.md
          echo "### ðŸ§ Linux" >> release-notes.md
          echo "" >> release-notes.md
          echo '**Debian/Ubuntu (.deb):**' >> release-notes.md
          echo '```bash' >> release-notes.md
          echo 'sudo dpkg -i ${{ env.APP_NAME }}-*.deb' >> release-notes.md
          echo 'sudo apt-get install -f  # Fix dependencies if needed' >> release-notes.md
          echo '```' >> release-notes.md
          echo "" >> release-notes.md
          echo '**Portable (.tar.gz):**' >> release-notes.md
          echo '```bash' >> release-notes.md
          echo 'tar -xzf ${{ env.APP_NAME }}-*-linux-portable.tar.gz' >> release-notes.md
          echo 'cd ${{ env.APP_NAME }}' >> release-notes.md
          echo './bin/${{ env.APP_NAME }}' >> release-notes.md
          echo '```' >> release-notes.md
          echo "" >> release-notes.md
          echo "### ðŸªŸ Windows" >> release-notes.md
          echo "" >> release-notes.md
          echo '**MSI Installer (Recommended):**' >> release-notes.md
          echo '1. Download the `.msi` file' >> release-notes.md
          echo '2. Double-click to launch the installer' >> release-notes.md
          echo '3. Follow the installation wizard' >> release-notes.md
          echo '4. Application will be added to Start Menu' >> release-notes.md
          echo "" >> release-notes.md
          echo '**Portable:**' >> release-notes.md
          echo '1. Extract the ZIP archive' >> release-notes.md
          echo '2. Navigate to extracted folder' >> release-notes.md
          echo '3. Run `bin\${{ env.APP_NAME }}.exe`' >> release-notes.md
          echo "" >> release-notes.md
          echo "### ðŸŽ macOS" >> release-notes.md
          echo "" >> release-notes.md
          echo '**DMG Installer (Recommended):**' >> release-notes.md
          echo '1. Download the `.dmg` file' >> release-notes.md
          echo '2. Open the DMG file' >> release-notes.md
          echo '3. Drag ${{ env.APP_NAME }} to the Applications folder' >> release-notes.md
          echo '4. Launch from Applications or Launchpad' >> release-notes.md
          echo "" >> release-notes.md
          echo '**Portable:**' >> release-notes.md
          echo '1. Extract the `.tar.gz` archive' >> release-notes.md
          echo '2. Run `${{ env.APP_NAME }}.app`' >> release-notes.md
          echo "" >> release-notes.md
          echo "## âš™ï¸ System Requirements" >> release-notes.md
          echo "" >> release-notes.md
          echo "- **RAM:** 4 GB minimum (8 GB recommended)" >> release-notes.md
          echo "- **Storage:** 500 MB available disk space" >> release-notes.md
          echo "- **Java:** Java 21 runtime **included** (no separate installation needed)" >> release-notes.md
          echo "- **Linux:** Ubuntu 18.04+, Debian 10+, Fedora 30+, or equivalent" >> release-notes.md
          echo "- **Windows:** Windows 10 (build 1809) or later" >> release-notes.md
          echo "- **macOS:** macOS 10.14 (Mojave) or later" >> release-notes.md
          echo "" >> release-notes.md
          echo "## ðŸ”§ Built with jpackage" >> release-notes.md
          echo "" >> release-notes.md
          echo "All installers are built using **jpackage**, Oracle's native packaging tool for Java applications." >> release-notes.md
          echo "This ensures:" >> release-notes.md
          echo "- Native platform integration" >> release-notes.md
          echo "- Bundled Java runtime (no separate JDK/JRE installation required)" >> release-notes.md
          echo "- Optimized application startup" >> release-notes.md
          echo "- Standard installation experience for each platform" >> release-notes.md

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "release-artifacts/*"
          bodyFile: "release-notes.md"
          draft: false
          prerelease: false
          generateReleaseNotes: true
          makeLatest: true
